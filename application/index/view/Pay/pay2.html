<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7" />
    <link href="/static/wang_pay/theme.css" rel="stylesheet" type="text/css"/>
    <link rel="stylesheet" href="/static/wang_pay/layui.css"  media="all">
    <script src="/static/admin/lib/layui/layui.js" charset="utf-8"></script>
    <script src="/static/wang_pay/common.js" charset="utf-8"></script>
    <script src="/static/wang_pay/md5.js" charset="utf-8"></script>
    <!--<script src="/static/webapp/js/jquery-3.2.1.min.js"></script>-->
    <title>充值</title>
</head>

<body>
<div class="panel">
    <div class="coin_deal">
        <form id="buyForm" name="buyForm" method="post" onsubmit="return false;" style="display: none;">
            <input type="hidden" id="pay_businessid" name="pay_businessid" value="<?php echo $param['pay_businessid']; ?>" />
            <input type="hidden" id="pay_memberid" name="pay_memberid" value="<?php echo $param['pay_memberid']; ?>" />
            <input type="hidden" id="key" name="key" value="<?php echo $param['key']; ?>" />

            <dl class="deal_buy">
                <dd>
                    <h1>充值</h1>
                    <h3>金额：</h3>
                    <h3><input type="text" id="pay_amount" name="pay_amount" value="{$param['money']}" placeholder="充值金额" style="height:30px;"/></h3>
                    <h2>付款方式：</h2>
                    <h4>
                        <!--<input type="checkbox" id="payWay_1"  name="payWay" value="101" />-->
                        <!--<em>支付宝</em>-->
                        <!--<input type="checkbox" id="payWay_2"  name="payWay" value="102"/>-->
                        <!--<em>微信</em>-->
                        <!--<input type="checkbox" id="payWay_3"  name="payWay" value="103"/>-->
                        <!--<em>银行卡</em>-->
                        <input type="checkbox"  name="payWay" value="{$param['pay_type']}" />
                    </h4>
                    <br />
                    <div class="deal_btn"><button id="buyBtn" class="deal_btn" style="width:90%;border:0;background-color: transparent;" lay-submit="" lay-filter="buyCoin"><em>支 付</em></button></div>
                </dd>
            </dl>
        </form>
    </div>

    <div class="m_title"><br /></div>
</div>
<script language="javascript">

    // document.getElementById('buyBtn').click();
    // $('#buyBtn').trigger('submit');
    //
    var can_submit = true;
    layui.use(['form','jquery', 'layer'], function(){
        var $ = layui.$
            ,layer = layui.layer
            ,form = layui.form;

    //     form.on('submit(buyCoin)', function (data) {
    submit_();
    function submit_() {
            var pay_amount = $("#pay_amount").val();
            //var coid = $("#coid").val();
            var pay_businessid = $("#pay_businessid").val();
            var pay_memberid = $("#pay_memberid").val();
            var key = $("#key").val();
            if(pay_amount.length == 0){
                layer.alert('买入数量不能为空！', {icon: 2,skin: 'layer-ext-moon',time:2000});
                $("#pay_amount").focus();
                return false;
            }
            if(!checkInteger(pay_amount)){
                layer.alert('买入数量只能是数字且为正整数！', {icon: 2,skin: 'layer-ext-moon',time:2000});
                $("#pay_amount").focus();
                return false;
            };
            if(!isNormalInteger(pay_amount)){
                layer.alert('买入数量只能为正整数，且介于1~100000之间的整数！', {icon: 2,skin: 'layer-ext-moon',time:2000});
                $("#pay_amount").focus();
                return false;
            };
            if(pay_amount <= 0){
                layer.alert('买入数量必须大于0！', {icon: 2,skin: 'layer-ext-moon',time:2000});
                $("#pay_amount").focus();
                return false;
            };
            if(pay_amount > 100000){
                layer.alert('买入数量不能大于100000！', {icon: 2,skin: 'layer-ext-moon',time:2000});
                $("#pay_amount").focus();
                return false;
            };
            // var alipay = $("#payWay_1");
            // var weixin = $("#payWay_2");
            // var union = $("#payWay_3");
            // if(alipay.prop('checked')==false && weixin.prop('checked')==false && union.prop('checked') == false){
            //     layer.alert('请至少选择一种付款方式！', {icon: 2,skin: 'layer-ext-moon',time:2000});
            //     return false;
            // }
            // var pay_payway = "";//对中文进行了编号的转换
            // if(alipay.prop('checked')){     //支付宝 = 101
            //     pay_payway += "101,";
            // }
            // if(weixin.prop('checked')){     //微信 = 102
            //     pay_payway += "102,";
            // }
            // if(union.prop('checked')){      //银行卡 = 103
            //     pay_payway += "103,";
            // }
            // console.log('3453453',pay_payway);

            var pay_payway = $('input[name="payWay"]').val();
            // if(pay_payway != ""){
            //     pay_payway = pay_payway.substring(0,pay_payway.length-1);
            // }
            // console.log(pay_amount,$('input[name="payWay"]').val());
            // return ;
            can_submit = false;
            $.post('{:url(\'Pay/pay2\')}',{"money":pay_amount,"pay_type":pay_payway},function (ret) {
                if(ret.code == 0){

                    var pay_orderid = ret.data.order_sn; //商家平台的订单编号，写成动态提取的
                    var pay_applydate = ret.data.pay_time; //提取支付时间，js写个获取当前日期的方法
                    var pay_callbackurl = ret.data.callback;
                    var stringSignTemp =  "pay_amount="+pay_amount+"&pay_applydate="+pay_applydate+"&pay_businessid="+pay_businessid+"&pay_callbackurl="+pay_callbackurl+"&pay_memberid="+pay_memberid+"&pay_orderid="+pay_orderid+"&pay_payway="+pay_payway+"&key="+key; //临时签名字符串，按照规则拼接
                    // alert(stringSignTemp);
                    //alert(stringSignTemp);
                    //alert(hex_md5("stringSignTemp"));
                    console.log(stringSignTemp);
                    var index = layer.load(0, {shade: false});
                    $.ajax({
                        url : "http://www.untracepay.in:8080/prePay.do?t="+new Date().getTime(),//远程地址接口
                        //url : "http://localhost:8080/utpay/prePay.do?t="+new Date().getTime(),//远程地址接口
                        type : "POST",
                        dataType:"jsonp",    //跨域json请求一定是jsonp
                        jsonp: "jsoncallback",    //跨域请求的参数名，默认是jsoncallback
                        //dataType : "json",
                        data : {
                            pay_businessid : pay_businessid,   //
                            pay_memberid : pay_memberid,     //
                            //key : key,              //
                            //coid : coid,
                            pay_amount : pay_amount, //
                            pay_orderid : pay_orderid, //商家网站传递来的订单号
                            pay_applydate : pay_applydate,       //支付的当前时间 ，yyyy-MM-dd HH:mm:ss
                            pay_callbackurl : pay_callbackurl,  //
                            pay_payway : pay_payway,  //支付宝,微信,银行卡的编号组成的字符串，逗号分隔，如：101,102,103
                            pay_md5sign : hex_md5(stringSignTemp)   //签名MD5加密 , 引用js的MD5的加密方式
                        },
                        success : function(data){
                            var json = eval("("+data.jsoncallback+")");
                            layer.close(index);
                            //$("#buyBtn").attr("disabled", false);
                            //console.log(data);
                            if(json.success){
                                payWin(json);
                            }else{
                                layer.alert(json.msg, {icon: 2,skin: 'layer-ext-moon',time:3000});
                                return false;
                            }
                        }
                    });


                }else{
                    can_submit = true;
                    layer.alert(ret.msg);
                }
            })
    }
        // });

        function payWin(json){
            var orid = json.orid ;
            var totalPrice = json.totalPrice ;
            var wName = json.wName ;
            var wUrl = json.wUrl;
            var aName = json.aName;
            var aUrl = json.aUrl;
            var payCode = json.payCode;
            var payeeName = json.payeeName;
            var bankOpen = json.bankOpen;
            var bankBranch = json.bankBranch;
            var bankCardNumber = json.bankCardNumber;

            var wTag = wUrl == "" ?  "" : "<br><img src='"+wUrl+"' width='200'/><br><br>支付码：<font color='#FF0000'>"+payCode+"</font> <br><br><font color='#FF0000'> * 转账时请备注支付码，用以确认身份 </font><br>";
            var aTag = aUrl == "" ? "" :  "<br><img src='"+aUrl+"' width='200'/><br><br>支付码：<font color='#FF0000'>"+payCode+"</font> <br><br><font color='#FF0000'> * 转账时请备注支付码，用以确认身份 </font><br>";
            var bTag = bankCardNumber == "" ?  "" : "<br>银行账号<br>收款人："+ payeeName+ "<br>开户银行："+ bankOpen +"<br>银行支行："+bankBranch+"<br>银行卡号："+bankCardNumber+"<br><br>支付码：<font color='#FF0000'>"+payCode+"</font> <br><br><font color='#FF0000'> * 转账时请备注支付码，用以确认身份 </font><br>";
            layer.open({
                type: 1
                ,title: "支付方式"
                ,closeBtn: false
                ,area: ['600px','500px;']
                ,shade: 0.8
                ,id: 'LAY_layuipro' //设定一个id，防止重复弹出
                ,btn: ['确认支付'/*,'取消订单'*/]
                ,btnAlign: 'c'
                ,moveType: 1 //拖拽模式，0或者1
                ,content: '<div align="center" style="padding: 10px; color: #000; font-weight: 300; height:400px;"><input type="hidden" id="orid" value="'+orid+'"/><br>'+ wTag + aTag + bTag +'<br><br><input id="paybyHand" type="checkbox" /> 我已确认已手动方式转账 '+totalPrice+' 元</div>'
                ,yes: function(index , layero ){
                    var btn = layero.find('.layui-layer-btn');
                    //layer.msg("按钮1回调,参数是:"+index)
                    btn.find('.layui-layer-btn0').attr({
                        onclick : doPay()
                    });
                }
            });
        }

        function doPay(){
            if($("#paybyHand").prop('checked') == false){
                layer.alert('请勾选“我已确认已手动方式转账”！', {icon: 2,skin: 'layer-ext-moon',time:2000});
                return false;
            }
            var orid = $('#orid').val();
            var index = layer.load(0, {shade: false});
            $.ajax({
                url : "http://www.untracepay.in:8080/payHandle.do?t="+new Date().getTime(),
                //url : "http://localhost:8080/utpay/payHandle.do?t="+new Date().getTime(),
                type : "POST",
                async: true,
                dataType:"jsonp",    //跨域json请求一定是jsonp
                jsonp: "jsoncallback",    //跨域请求的参数名，默认是callback
                data : {
                    orid : orid
                },
                success : function(data){
                    var json = eval("("+data.jsoncallback+")");
                    layer.close(index);
                    if(json.success){
                        layer.closeAll();
                        layer.alert(json.msg, {icon: 1,skin: 'layer-ext-moon',time:3000 ,end:function (){
                            location.href = '{:url("user/index")}';
                        }});
                    }else{
                        layer.alert(json.msg, {icon: 2,skin: 'layer-ext-moon',time:3000});
                        return false;
                    }
                }/*,
			error : function(response) {

		    },
		    timeout : 9000*/
            });

        }

    });
</script>
</body>
</html>
